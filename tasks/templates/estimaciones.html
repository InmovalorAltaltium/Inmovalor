{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
    :root {
        --primary-color: #00CCCC;
        --secondary-color: #009999;
        --accent-color: #CCF5F5;
        --dark-color: #003035;
        --light-color: #FFFFFF;
        --error-color: #FF6B6B;
        --success-color: #66CC99;
    }

    .estimaciones-container {
        background: linear-gradient(-45deg, #fefcef, #bfc6c7, #52b3c0, #00cccc);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        min-height: calc(100vh - 100px);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding-top: 100px;
    }

    @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .form-container {
        background-color: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(8px);
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        border-left: 3px solid var(--primary-color);
        height: 450px;
        overflow-y: auto;
        transition: all 0.3s ease;
        scroll-behavior: smooth;
    }

    .form-container:hover {
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
    }

    .form-title {
        color: var(--dark-color);
        font-weight: 700;
        margin-bottom: 0.8rem;
        margin-top: 0.5rem;
        position: relative;
        padding-bottom: 0.2rem;
        text-align: center;
        font-size: 1.4rem;
    }

    .form-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 50px;
        height: 2px;
        background: var(--primary-color);
        border-radius: 2px;
    }

    .form-label {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 0.2rem;
        font-size: 0.8rem;
    }

    .required-field::after {
        content: " *";
        color: var(--error-color);
    }

    .section-title {
        color: var(--dark-color);
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 0.8rem;
        margin-bottom: 0.4rem;
        position: relative;
        padding-left: 0.6rem;
    }

    .section-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        height: 50%;
        width: 3px;
        background: var(--primary-color);
        border-radius: 2px;
    }

    .btn-calculate {
        background-color: var(--primary-color);
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.4rem 1rem;
        border-radius: 5px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 204, 204, 0.2);
    }

    .btn-calculate:hover {
        background-color: var(--secondary-color);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 204, 204, 0.3);
    }

    .btn-secondary {
        background-color: var(--dark-color);
        color: white;
        font-weight: 500;
        border-radius: 5px;
        padding: 0.3rem 0.8rem;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background-color: var(--secondary-color);
        color: white;
        transform: translateY(-2px);
    }

    #map {
        height: 450px;
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }

    #map:hover {
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .map-message {
        padding: 6px 12px;
        background: white;
        border-radius: 5px;
        text-align: center;
        margin-bottom: 6px;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-width: 90%;
        margin-left: auto;
        margin-right: auto;
        color: black;
    }

    .error-message {
        color: white;
        background-color: var(--error-color);
    }

    .success-message {
        color: white;
        background-color: var(--success-color);
    }

    .form-status-message {
        font-size: 0.8rem;
        font-weight: 500;
        text-align: center;
        margin-top: 0.5rem;
        padding: 0.4rem;
        border-radius: 5px;
        transition: all 0.3s ease;
    }

    .form-status-message.success {
        color: var(--success-color);
        background-color: rgba(102, 204, 153, 0.1);
    }

    .form-status-message.error {
        color: var(--error-color);
        background-color: rgba(255, 107, 107, 0.1);
    }

    .form-control, .form-select {
        border-radius: 5px;
        padding: 0.4rem 0.7rem;
        border: 1px solid #ced4da;
        transition: all 0.3s ease;
        font-size: 0.85rem;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 0.15rem rgba(0, 204, 204, 0.25);
        background: var(--light-color);
    }

    .invalid-feedback {
        font-size: 0.7rem;
        color: var(--error-color);
    }

    .animate-fade-in {
        animation: fadeIn 0.6s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .animate-float {
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-5px); }
        100% { transform: translateY(0px); }
    }

    .input-group-text {
        background-color: var(--accent-color);
        color: var(--dark-color);
        border-radius: 5px 0 0 5px;
        transition: all 0.3s ease;
        padding: 0.4rem 0.6rem;
    }

    .input-group:focus-within .input-group-text {
        background-color: var(--primary-color);
        color: white;
    }

    .loading-spinner {
        display: none;
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%);
    }

    .form-control.is-loading {
        padding-right: 30px;
    }

    .pulse-animation {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(0, 204, 204, 0.7); }
        70% { box-shadow: 0 0 0 6px rgba(0, 204, 204, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 204, 204, 0); }
    }

    .container-fluid {
        padding: 0.5rem;
    }
</style>

<div class="estimaciones-container">
    <div class="container-fluid py-2 animate-fade-in">
        <div class="row g-2">
            <!-- Formulario -->
            <div class="col-lg-6">
                <div class="form-container">
                    <h1 class="form-title">Estimación de Propiedad</h1>
                    <form method="POST" class="row g-2 needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="col-md-6">
                            <label class="form-label required-field">Tipo de propiedad</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-building"></i></span>
                                <select id="tipo_propiedad" name="tipo_propiedad" class="form-select" required>
                                    <option selected disabled value="">Seleccionar...</option>
                                    <option value="Casa">Casa</option>
                                    <option value="Departamento">Departamento</option>
                                    <option value="Terreno">Terreno</option>
                                </select>
                                <div class="invalid-feedback">Selecciona una opción válida.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Estado</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                <select class="form-control" id="estado" name="estado" required>
                                    <option selected disabled value="">Seleccionar...</option>
                                    {% for estado in estados %}
                                    <option value="{{ estado.id_estado }}">{{ estado.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Selecciona una opción válida.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Alcaldía/Municipio</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-city"></i></span>
                                <select class="form-control" id="municipio" name="municipio" required>
                                    <option selected disabled value="">Seleccionar...</option>
                                    {% for municipio in municipios %}
                                    <option value="{{ municipio.id_municipio }}">{{ municipio.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <div class="loading-spinner" id="municipio-spinner">
                                    <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div class="invalid-feedback">Selecciona una opción válida.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Colonia</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-map-pin"></i></span>
                                <select id="colonia" name="colonia" class="form-control" required>
                                    <option selected disabled value="">Seleccionar...</option>
                                    {% for colonia in colonias %}
                                    <option value="{{ colonia.id_colonia }}">{{ colonia.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <div class="loading-spinner" id="colonia-spinner">
                                    <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <div class="invalid-feedback">Selecciona una opción válida.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Código Postal</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-mail-bulk"></i></span>
                                <select id="cp" name="cp" class="form-control" required>
                                    <option selected disabled value="">Seleccionar...</option>
                                </select>
                                <div class="invalid-feedback">Selecciona una opción válida.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Calle</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-road"></i></span>
                                <input id="calle" name="calle" type="text" class="form-control" placeholder="Ej. Av. Revolución 123" required>
                                <div class="invalid-feedback">Introduce una calle válida.</div>
                            </div>
                        </div>
                        <div class="col-12 mb-1">
                            <button type="button" id="btnUbicar" class="btn btn-secondary animate-float">
                                <i class="fas fa-map-marker-alt me-2"></i> Ubicar en mapa
                            </button>
                        </div>
                        <div class="col-12">
                            <span class="section-title">Características de la propiedad</span>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label required-field">Recámaras</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-bed"></i></span>
                                <input id="recamaras" name="recamaras" type="number" class="form-control" min="0" required>
                                <div class="invalid-feedback">Campo requerido.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label required-field">Sanitarios</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-bath"></i></span>
                                <input id="sanitarios" name="sanitarios" type="number" class="form-control" min="0" required>
                                <div class="invalid-feedback">Campo requerido.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label required-field">Estacionamiento</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-car"></i></span>
                                <input id="estacionamiento" name="estacionamiento" type="number" class="form-control" min="0" required>
                                <div class="invalid-feedback">Campo requerido.</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Comentarios adicionales</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-comment-alt"></i></span>
                                <textarea id="comentarios" name="comentarios" class="form-control" rows="2" placeholder="Ej. Terraza, jardín, amenidades..."></textarea>
                            </div>
                        </div>
                        <div class="col-12 mt-1">
                            <span class="section-title">Metraje</span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Terreno (m²)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-vector-square"></i></span>
                                <input id="terreno" name="terreno" type="number" class="form-control" min="0" required>
                                <div class="invalid-feedback">Campo requerido.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Construcción (m²)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-home"></i></span>
                                <input id="construccion" name="construccion" type="number" class="form-control" min="0" required>
                                <div class="invalid-feedback">Campo requerido.</div>
                            </div>
                        </div>
                        <div class="col-12 mt-2 text-center">
                            <button type="submit" class="btn btn-calculate pulse-animation">
                                <i class="fas fa-calculator me-2"></i> Calcular
                            </button>
                        </div>
                        {% if messages %}
                            {% for message in messages %}
                                <div class="col-12 mt-2">
                                    <div class="form-status-message {{ message.tags }}">
                                        {{ message }}
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </form>
                </div>
            </div>
            <!-- Mapa -->
            <div class="col-lg-6">
                <div class="input-group mb-2">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input id="searchBox" type="text" class="form-control" placeholder="Buscar dirección...">
                </div>
                <div id="map"></div>
            </div>
        </div>
    </div>
</div>

<!-- Inclusión de Google Maps -->
<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDldEaEtV3NdG-fY-us0SmbBSh8RHibnpU&libraries=places,geometry&callback=initMap"
    async defer>
</script>

<!-- Inclusión de Font Awesome y Animate.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<script>
    let map, marker, geocoder, autocomplete;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 19.432608, lng: -99.133209 },
            zoom: 12,
            disableDefaultUI: true,
            zoomControl: true,
            streetViewControl: false,
        });

        marker = new google.maps.Marker({
            map: map,
            draggable: true,
        });

        geocoder = new google.maps.Geocoder();
        autocomplete = new google.maps.places.Autocomplete(document.getElementById("searchBox"), {
            types: ["address"],
            componentRestrictions: { country: "mx" },
        });

        autocomplete.bindTo("bounds", map);

        autocomplete.addListener("place_changed", function () {
            const place = autocomplete.getPlace();
            if (!place.geometry) {
                showMapMessage("No se encontraron detalles para la dirección ingresada.", "error");
                return;
            }

            if (place.geometry.viewport) {
                map.fitBounds(place.geometry.viewport);
            } else {
                map.setCenter(place.geometry.location);
                map.setZoom(17);
            }

            marker.setPosition(place.geometry.location);
            marker.setVisible(true);
            fillAddressFields(place);
        });

        marker.addListener("dragend", function () {
            const position = marker.getPosition();
            geocoder.geocode({ location: position }, function (results, status) {
                if (status === "OK" && results[0]) {
                    document.getElementById("searchBox").value = results[0].formatted_address;
                    fillAddressFields(results[0]);
                    showMapMessage("Ubicación actualizada desde el marcador.", "success");
                } else {
                    showMapMessage("No se pudo obtener la dirección de la ubicación seleccionada.", "error");
                }
            });
        });

        document.getElementById("btnUbicar").addEventListener("click", function () {
            const address = buildAddress();
            if (address) {
                geocoder.geocode({ address: address, componentRestrictions: { country: "MX" } }, function (results, status) {
                    if (status === "OK" && results[0]) {
                        map.setCenter(results[0].geometry.location);
                        map.setZoom(17);
                        marker.setPosition(results[0].geometry.location);
                        marker.setVisible(true);
                        document.getElementById("searchBox").value = results[0].formatted_address;
                        fillAddressFields(results[0]);
                        showMapMessage("Ubicación encontrada en el mapa.", "success");
                    } else {
                        showMapMessage("No se pudo encontrar la dirección ingresada.", "error");
                    }
                });
            } else {
                showMapMessage("Por favor, completa todos los campos de dirección.", "error");
            }
        });
    }

    function fillAddressFields(place) {
        let street = "", cp = "", colonia = "", municipio = "", estado = "";
        for (const component of place.address_components) {
            if (component.types.includes("street_number") || component.types.includes("route")) {
                street += (street ? " " : "") + component.long_name;
            } else if (component.types.includes("postal_code")) {
                cp = component.long_name;
            } else if (component.types.includes("sublocality_level_1") || component.types.includes("neighborhood")) {
                colonia = component.long_name;
            } else if (component.types.includes("locality") || component.types.includes("administrative_area_level_2")) {
                municipio = component.long_name;
            } else if (component.types.includes("administrative_area_level_1")) {
                estado = component.long_name;
            }
        }

        document.getElementById("calle").value = street || "";
        document.getElementById("cp").value = cp || "";
        selectOptionByText("colonia", colonia);
        selectOptionByText("municipio", municipio);
        selectOptionByText("estado", estado);
    }

    function selectOptionByText(selectId, text) {
        const select = document.getElementById(selectId);
        if (!select) return;
        for (const option of select.options) {
            if (option.text === text) {
                select.value = option.value;
                break;
            }
        }
    }

    function buildAddress() {
        const calle = document.getElementById("calle").value;
        const cp = document.getElementById("cp").value;
        const colonia = document.getElementById("colonia").options[document.getElementById("colonia").selectedIndex]?.text;
        const municipio = document.getElementById("municipio").options[document.getElementById("municipio").selectedIndex]?.text;
        const estado = document.getElementById("estado").options[document.getElementById("estado").selectedIndex]?.text;

        if (!calle || !cp || !colonia || !municipio || !estado) return null;
        return `${calle}, ${colonia}, ${municipio}, ${estado}, ${cp}, México`;
    }

    function showMapMessage(message, type) {
        const mapDiv = document.getElementById("map");
        let messageDiv = document.querySelector(".map-message");
        if (!messageDiv) {
            messageDiv = document.createElement("div");
            messageDiv.className = "map-message";
            mapDiv.parentNode.insertBefore(messageDiv, mapDiv);
        }
        messageDiv.textContent = message;
        messageDiv.className = `map-message ${type === "success" ? "success-message" : "error-message"}`;
        setTimeout(() => {
            messageDiv.style.opacity = "0";
            setTimeout(() => messageDiv.remove(), 300);
        }, 3000);
    }

    // Validación del formulario
    (function () {
        'use strict';
        const forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();
</script>
{% endblock %}